name: Java CI with Gradle

on: [push, pull_request]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:

      - name: Checkout repository
        uses: actions/checkout@v3


      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'


      - name: Make gradlew executable
        run: chmod +x ./gradlew


      - name: Build project
        run: ./gradlew assemble --no-daemon


      - name: Start SUT (application) in background and wait for it
        run: |
          
          nohup java -jar ./artifacts/app-mbank.jar > sut.log 2>&1 &

         
          APP_PORT=9999
          
          echo "Waiting for SUT to start on port $APP_PORT..."

          
          for i in {1..30}; do
            
            if curl --silent --fail http://localhost:$APP_PORT/ >/dev/null 2>&1; then
              echo "SUT is up and running!"
              break
            fi
            echo "Attempt $i: Waiting..."
            sleep 1
          done

          
          if ! curl --silent --fail http://localhost:$APP_PORT/ >/dev/null 2>&1; then
            echo "Error: SUT did not start within the timeout."
            echo "Last 200 lines of sut.log:"
            tail -n 200 sut.log || true
            exit 1
          fi


      - name: Run tests