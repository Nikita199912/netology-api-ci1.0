name: Java CI с Gradle

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build project
        run: ./gradlew assemble --no-daemon

      - name: Start SUT (application) in background and wait for it
        run: |
          # Запускаем JAR в фоне и пишем лог
          nohup java -jar ./artifacts/app-mbank.jar > sut.log 2>&1 &

          APP_PORT=9999
          echo "Waiting for SUT to start on port $APP_PORT..."

          # Ждём до 30 секунд, принимаем любой HTTP-ответ (даже 404) как признак работы сервиса
          code="000"
          for i in {1..30}; do
            code=$(curl -sS -o /dev/null -w "%{http_code}" http://localhost:$APP_PORT/ || echo "000")
            if [ "$code" != "000" ]; then
              echo "SUT responded with HTTP $code"
              break
            fi
            echo "Attempt $i: waiting..."
            sleep 1
          done

          if [ "$code" = "000" ]; then
            echo "Error: SUT did not start within the timeout. Last lines of sut.log:"
            tail -n 200 sut.log || true
            exit 1
          fi

      - name: Run tests
        run: ./gradlew test --info -Dselenide.headless=true --no-daemon