name: Java CI with Gradle

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build project (assemble)
        run: ./gradlew assemble --no-daemon

      - name: Start SUT (application) in background and wait for it
        run: |
          # запуск в фоне, лог в файл
          nohup java -jar ./artifacts/app-mbank.jar > sut.log 2>&1 &

          # простой цикл ожидания порта (поменяй 8080 на нужный порт)
          for i in {1..30}; do
            if curl --silent --fail http://localhost:8080/ >/dev/null 2>&1; then
              echo "SUT is up"
              break
            fi
            echo "Waiting for SUT... ($i)"
            sleep 1
          done

          # если не поднялся — вывести лог и завершить с ошибкой
          if ! curl --silent --fail http://localhost:8080/ >/dev/null 2>&1; then
            echo "SUT did not start, last lines of sut.log:"
            tail -n 200 sut.log || true
            exit 1
          fi

      - name: Run tests
        run: |